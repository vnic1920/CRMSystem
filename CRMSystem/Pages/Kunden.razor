@page "/kunden"
@using CRMSystem.Services
@using CRMSystem.Models
@using CRMSystem.Data
@using System.Text
@using System.ComponentModel.DataAnnotations
@inject IKundeService KundeService
@inject IJSRuntime JSRuntime

<PageTitle>Kunden - CRM System</PageTitle>

<h1>👥 Kundenverwaltung</h1>

<!-- Loading Indicator -->
@if (isLoading)
{
    <div class="text-center p-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Laden...</span>
        </div>
        <p class="mt-3 text-muted">Kunden werden geladen...</p>
    </div>
}
else
{
    <!-- Erweiterte Suche und Filter -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">🔍 Erweiterte Suche & Filter</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">🔍</span>
                        <input @bind="suchText" @oninput="@((ChangeEventArgs e) => { suchText = e.Value?.ToString() ?? ""; FilternUndSortieren(); })"
                               class="form-control" placeholder="Kundenname, Email oder Firma suchen..." />
                        @if (!string.IsNullOrEmpty(suchText))
                        {
                            <button @onclick="SuchTextLeeren" class="btn btn-outline-secondary" type="button" title="Suche löschen">
                                ✕
                            </button>
                        }
                    </div>
                </div>
                <div class="col-md-3">
                    <select value="@sortierung" @onchange="@((ChangeEventArgs e) => { sortierung = e.Value?.ToString() ?? "name"; FilternUndSortieren(); })" class="form-select">
                        <option value="name">📝 Nach Name A-Z</option>
                        <option value="namedesc">📝 Nach Name Z-A</option>
                        <option value="firma">🏢 Nach Firma</option>
                        <option value="datum">📅 Neueste zuerst</option>
                        <option value="datumalt">📅 Älteste zuerst</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select value="@statusFilter" @onchange="@((ChangeEventArgs e) => { statusFilter = e.Value?.ToString() ?? "alle"; FilternUndSortieren(); })" class="form-select">
                        <option value="alle">👥 Alle Kunden</option>
                        <option value="mitFirma">🏢 Mit Firma</option>
                        <option value="ohneFirma">❌ Ohne Firma</option>
                        <option value="mitTelefon">📞 Mit Telefon</option>
                        <option value="heute">🆕 Heute erstellt</option>
                    </select>
                </div>
            </div>

            <!-- Filter-Status -->
            @if (!string.IsNullOrEmpty(suchText) || statusFilter != "alle")
            {
                <div class="alert alert-info mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small>
                                @if (!string.IsNullOrEmpty(suchText))
                                {
                                    <span class="badge bg-primary me-2">🔍 Suche: "@suchText"</span>
                                }
                                @if (statusFilter != "alle")
                                {
                                    <span class="badge bg-secondary me-2">📊 Filter: @statusFilter</span>
                                }
                                <span class="badge bg-success">📈 Gefunden: @gefilterteKunden.Count von @kunden.Count Kunden</span>
                            </small>
                        </div>
                        <button @onclick="AlleFilterZuruecksetzen" class="btn btn-sm btn-outline-danger">❌ Alle Filter löschen</button>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Neuer Kunden Formular -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">➕ Neuen Kunden anlegen</h5>
        </div>
        <div class="card-body">
            <EditForm Model="neuerKunde" OnValidSubmit="KundeHinzufuegen">
                <DataAnnotationsValidator />
                <div class="row">
                    <div class="col-lg-8">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Name *</label>
                                    <InputText @bind-Value="neuerKunde.Name" class="form-control" placeholder="Vor- und Nachname eingeben" />
                                    <ValidationMessage For="@(() => neuerKunde.Name)" class="text-danger small" />
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Email</label>
                                    <InputText @bind-Value="neuerKunde.Email" class="form-control" placeholder="email@beispiel.de" />
                                    <ValidationMessage For="@(() => neuerKunde.Email)" class="text-danger small" />
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Telefon</label>
                                    <InputText @bind-Value="neuerKunde.Telefon" class="form-control" placeholder="+49 123 456789" />
                                    <ValidationMessage For="@(() => neuerKunde.Telefon)" class="text-danger small" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Firma</label>
                                    <InputText @bind-Value="neuerKunde.Firma" class="form-control" placeholder="Firmenname" />
                                    <ValidationMessage For="@(() => neuerKunde.Firma)" class="text-danger small" />
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Adresse</label>
                                    <InputTextArea @bind-Value="neuerKunde.Adresse" class="form-control" placeholder="Straße, PLZ, Stadt" rows="3" />
                                    <ValidationMessage For="@(() => neuerKunde.Adresse)" class="text-danger small" />
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label fw-bold">Notizen</label>
                            <InputTextArea @bind-Value="neuerKunde.Notizen" class="form-control" placeholder="Interne Notizen und Kommentare..." rows="2" />
                            <ValidationMessage For="@(() => neuerKunde.Notizen)" class="text-danger small" />
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-person-plus"></i> Kunde hinzufügen
                            </button>
                            <button type="button" class="btn btn-outline-secondary" @onclick="FormularZuruecksetzen">
                                🔄 Zurücksetzen
                            </button>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="alert alert-light border">
                            <h6>💡 Tipps:</h6>
                            <ul class="small mb-0">
                                <li>Name ist ein Pflichtfeld</li>
                                <li>Email muss gültig sein</li>
                                <li>Telefonnummer wird automatisch formatiert</li>
                                <li>Notizen sind für interne Informationen</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>

    <!-- Status Messages -->
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            @statusMessage
            <button type="button" class="btn-close" @onclick="StatusMessageSchliessen"></button>
        </div>
    }

    <!-- Kundenliste Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>📋 Kundenliste</h3>
        <div class="d-flex gap-2">
            <!-- 👇 ОНОВЛЕНІ КНОПКИ -->
            <button @onclick="Exportieren" class="btn btn-success" title="Daten exportieren">
                📤 CSV Export
            </button>
            <button @onclick="ImportDialogAnzeigen" class="btn btn-warning" title="Daten importieren">
                📥 CSV Import
            </button>
            <button @onclick="LoadKunden" class="btn btn-outline-primary" title="Aktualisieren">
                🔄 Aktualisieren
            </button>
        </div>
    </div>

    <!-- Kunden Tabelle -->
    @if (gefilterteKunden.Count == 0)
    {
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <div class="text-muted mb-3">
                    <i class="bi bi-people" style="font-size: 3rem;"></i>
                </div>
                <h5 class="text-muted">Keine Kunden gefunden</h5>
                <p class="text-muted">
                    @(kunden.Count == 0 ? "Fügen Sie Ihren ersten Kunden hinzu!" : "Versuchen Sie einen anderen Suchbegriff oder Filter.")
                </p>
                @if (kunden.Count == 0)
                {
                    <button @onclick="ScrollToForm" class="btn btn-primary">
                        ➕ Ersten Kunden anlegen
                    </button>
                }
            </div>
        </div>
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th width="80">ID</th>
                                <th>Kunde</th>
                                <th>Kontakt</th>
                                <th>Unternehmen</th>
                                <th width="120">Erstellt am</th>
                                <th width="150" class="text-center">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var kunde in gefilterteKunden)
                            {
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary">#@kunde.Id</span>
                                    </td>
                                    <td>
                                        <div class="fw-bold text-primary">@kunde.Name</div>
                                        @if (!string.IsNullOrEmpty(kunde.Notizen))
                                        {
                                            <small class="text-muted" title="@kunde.Notizen">
                                                <i class="bi bi-chat-text"></i> Notizen vorhanden
                                            </small>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(kunde.Email))
                                        {
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="bi bi-envelope text-muted me-2"></i>
                                                <small>@kunde.Email</small>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(kunde.Telefon))
                                        {
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-telephone text-muted me-2"></i>
                                                <small>@kunde.Telefon</small>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(kunde.Firma))
                                        {
                                            <span class="badge bg-light text-dark">@kunde.Firma</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <small class="text-muted">@kunde.Erstellungsdatum.ToString("dd.MM.yyyy")</small>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button @onclick="() => BearbeitenStarten(kunde.Id)"
                                                    class="btn btn-outline-warning" title="Kunde bearbeiten">
                                                ✏️
                                            </button>
                                            <button @onclick="() => LoeschenBestätigen(kunde)"
                                                    class="btn btn-outline-danger" title="Kunde löschen">
                                                🗑️
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pagination Info -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <small class="text-muted">
                Zeige @gefilterteKunden.Count von @kunden.Count Kunden
            </small>
            @if (gefilterteKunden.Count > 10)
            {
                <small class="text-muted">
                    ⚡ Tipp: Verwenden Sie die Filter für bessere Übersicht
                </small>
            }
        </div>
    }

    <!-- 👇 НОВИЙ MODAL ДЛЯ ІМПОРТУ -->
    @if (importModal)
    {
        <div class="modal show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">📥 Kunden importieren</h5>
                        <button type="button" class="btn-close" @onclick="ImportAbbrechen"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <h6>📋 CSV Format:</h6>
                            <small>
                                Erwartetes Format: <strong>ID;Name;Email;Telefon;Firma;Adresse;Notizen</strong><br />
                                Die erste Zeile (Header) wird übersprungen.<br />
                                Beispiel-Daten sind bereits eingefügt.
                            </small>
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label fw-bold">CSV-Daten einfügen:</label>
                            <textarea @bind="csvImportDaten" class="form-control" rows="10"
                                      placeholder="ID;Name;Email;Telefon;Firma;Adresse;Notizen&#10;1;Max Mustermann;max@example.com;+49123456789;Muster GmbH;Musterstraße 1, 12345 Berlin;Notizen..."></textarea>
                        </div>

                        @if (importResults.Any())
                        {
                            <div class="alert @(importResults.Any(r => r.Contains("❌")) ? "alert-danger" : "alert-success")">
                                <h6>Import Ergebnisse:</h6>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    @foreach (var result in importResults)
                                    {
                                        <div>@result</div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button @onclick="ImportAbbrechen" class="btn btn-secondary">❌ Abbrechen</button>
                        <button @onclick="KundenImportieren" class="btn btn-warning" disabled="@isImporting">
                            @if (isImporting)
                            {
                                <span>🔄 Importiere...</span>
                            }
                            else
                            {
                                <span>📥 Import starten</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Bearbeiten Modal -->
    @if (bearbeitenModal)
    {
        <div class="modal show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">✏️ Kunde bearbeiten</h5>
                        <button type="button" class="btn-close" @onclick="BearbeitenAbbrechen"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Name *</label>
                                    <input @bind="bearbeitenKunde.Name" class="form-control" />
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Email</label>
                                    <input @bind="bearbeitenKunde.Email" class="form-control" />
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Telefon</label>
                                    <input @bind="bearbeitenKunde.Telefon" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Firma</label>
                                    <input @bind="bearbeitenKunde.Firma" class="form-control" />
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Adresse</label>
                                    <textarea @bind="bearbeitenKunde.Adresse" class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label fw-bold">Notizen</label>
                            <textarea @bind="bearbeitenKunde.Notizen" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button @onclick="BearbeitenAbbrechen" class="btn btn-secondary">❌ Abbrechen</button>
                        <button @onclick="KundeAktualisieren" class="btn btn-primary">💾 Speichern</button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Löschen Modal -->
    @if (loeschenModal)
    {
        <div class="modal show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">🗑️ Kunde löschen</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="LoeschenAbbrechen"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <h6>⚠️ Achtung: Diese Aktion kann nicht rückgängig gemacht werden!</h6>
                            <p class="mb-0 mt-2">Sind Sie sicher, dass Sie den Kunden <strong class="text-dark">@loeschenKunde?.Name</strong> löschen möchten?</p>
                            @if (!string.IsNullOrEmpty(loeschenKunde?.Firma))
                            {
                                <p class="mb-0 mt-1"><strong>Firma:</strong> @loeschenKunde.Firma</p>
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button @onclick="LoeschenAbbrechen" class="btn btn-secondary">❌ Abbrechen</button>
                        <button @onclick="KundeLoeschen" class="btn btn-danger">🗑️ Endgültig löschen</button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Navigation -->
    <div class="mt-4 pt-3 border-top">
        <div class="d-flex gap-2">
            <a href="/" class="btn btn-outline-primary">
                ← Dashboard
            </a>
            <a href="/aufgaben" class="btn btn-outline-success">
                📋 Aufgaben
            </a>
            <a href="/kontakte" class="btn btn-outline-info">
                📞 Kontakte
            </a>
        </div>
    </div>
}

@code {
    private List<Kunde> kunden = [];
    private List<Kunde> gefilterteKunden = [];
    private Kunde neuerKunde = new();
    private string statusMessage = "";
    private string suchText = "";
    private string sortierung = "name";
    private string statusFilter = "alle";
    private bool isLoading = false;

    private bool bearbeitenModal = false;
    private Kunde bearbeitenKunde = new();

    private bool loeschenModal = false;
    private Kunde? loeschenKunde;

    // 👇 НОВІ ЗМІННІ ДЛЯ ІМПОРТУ
    private bool importModal = false;
    private string csvImportDaten = "";
    private List<string> importResults = [];
    private bool isImporting = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadKunden();
    }

    private async Task LoadKunden()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            kunden = await KundeService.GetKundenAsync();
            FilternUndSortieren();
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Fehler beim Laden der Kunden: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void FilternUndSortieren()
    {
        var result = kunden;

        // Text-Suche
        if (!string.IsNullOrWhiteSpace(suchText))
        {
            var search = suchText.ToLower();
            result = result.Where(k =>
                k.Name.ToLower().Contains(search) ||
                (k.Email != null && k.Email.ToLower().Contains(search)) ||
                (!string.IsNullOrEmpty(k.Firma) && k.Firma.ToLower().Contains(search)) ||
                (!string.IsNullOrEmpty(k.Telefon) && k.Telefon.Contains(search))
            ).ToList();
        }

        // Status-Filter
        if (statusFilter != "alle")
        {
            result = statusFilter switch
            {
                "mitFirma" => result.Where(k => !string.IsNullOrEmpty(k.Firma)).ToList(),
                "ohneFirma" => result.Where(k => string.IsNullOrEmpty(k.Firma)).ToList(),
                "mitTelefon" => result.Where(k => !string.IsNullOrEmpty(k.Telefon)).ToList(),
                "heute" => result.Where(k => k.Erstellungsdatum.Date == DateTime.Today).ToList(),
                _ => result
            };
        }

        // Sortierung
        result = sortierung switch
        {
            "name" => result.OrderBy(k => k.Name).ToList(),
            "namedesc" => result.OrderByDescending(k => k.Name).ToList(),
            "firma" => result.OrderBy(k => k.Firma).ToList(),
            "datum" => result.OrderByDescending(k => k.Erstellungsdatum).ToList(),
            "datumalt" => result.OrderBy(k => k.Erstellungsdatum).ToList(),
            _ => result.OrderBy(k => k.Name).ToList()
        };

        gefilterteKunden = result;
        StateHasChanged();
    }

    private void SuchTextLeeren()
    {
        suchText = "";
        FilternUndSortieren();
    }

    private void AlleFilterZuruecksetzen()
    {
        suchText = "";
        statusFilter = "alle";
        sortierung = "name";
        FilternUndSortieren();
    }

    private void FormularZuruecksetzen()
    {
        neuerKunde = new Kunde();
        StateHasChanged();
    }

    private void StatusMessageSchliessen()
    {
        statusMessage = "";
        StateHasChanged();
    }

    private async Task KundeHinzufuegen()
    {
        try
        {
            neuerKunde.Erstellungsdatum = DateTime.Now;
            await KundeService.AddKundeAsync(neuerKunde);
            statusMessage = $"✅ Kunde '{neuerKunde.Name}' wurde erfolgreich gespeichert!";

            neuerKunde = new Kunde();
            await LoadKunden();
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Fehler beim Speichern: {ex.Message}";
        }
    }

    private async Task BearbeitenStarten(int id)
    {
        try
        {
            var kunde = await KundeService.GetKundeByIdAsync(id);
            if (kunde != null)
            {
                bearbeitenKunde = new Kunde
                {
                    Id = kunde.Id,
                    Name = kunde.Name,
                    Email = kunde.Email,
                    Telefon = kunde.Telefon,
                    Firma = kunde.Firma,
                    Adresse = kunde.Adresse,
                    Notizen = kunde.Notizen
                };
                bearbeitenModal = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Fehler beim Laden: {ex.Message}";
        }
    }

    private void BearbeitenAbbrechen()
    {
        bearbeitenModal = false;
        bearbeitenKunde = new Kunde();
        StateHasChanged();
    }

    private async Task KundeAktualisieren()
    {
        try
        {
            await KundeService.UpdateKundeAsync(bearbeitenKunde);
            statusMessage = $"✅ Kunde '{bearbeitenKunde.Name}' wurde erfolgreich aktualisiert!";
            bearbeitenModal = false;
            await LoadKunden();
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Fehler beim Aktualisieren: {ex.Message}";
        }
    }

    private void LoeschenBestätigen(Kunde kunde)
    {
        loeschenKunde = kunde;
        loeschenModal = true;
        StateHasChanged();
    }

    private void LoeschenAbbrechen()
    {
        loeschenModal = false;
        loeschenKunde = null;
        StateHasChanged();
    }

    private async Task KundeLoeschen()
    {
        if (loeschenKunde != null)
        {
            try
            {
                await KundeService.DeleteKundeAsync(loeschenKunde.Id);
                statusMessage = $"🗑️ Kunde '{loeschenKunde.Name}' wurde erfolgreich gelöscht!";
                loeschenModal = false;
                loeschenKunde = null;
                await LoadKunden();
            }
            catch (Exception ex)
            {
                statusMessage = $"❌ Fehler beim Löschen: {ex.Message}";
            }
        }
    }

    private async Task Exportieren()
    {
        try
        {
            var csvData = await KundeService.ExportKundenToCsvAsync();
            var fileName = $"Kunden_Export_{DateTime.Now:yyyy-MM-dd_HH-mm}.csv";
            await DownloadFile(csvData, fileName, "text/csv");
            statusMessage = $"✅ Export erfolgreich! Datei '{fileName}' wurde heruntergeladen.";
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Export fehlgeschlagen: {ex.Message}";
        }
        StateHasChanged();
    }

    // 👇 НОВІ МЕТОДИ ДЛЯ ІМПОРТУ
    private void ImportDialogAnzeigen()
    {
        importModal = true;
        csvImportDaten = "ID;Name;Email;Telefon;Firma;Adresse;Notizen\n1;Max Mustermann;max@example.com;+49123456789;Muster GmbH;Musterstraße 1, 12345 Berlin;Notizen...\n2;Maria Schmidt;maria@example.com;+49123456780;Schmidt AG;Hauptstraße 15, 10115 Berlin;Wichtiger Kunde";
        importResults.Clear();
        StateHasChanged();
    }

    private void ImportAbbrechen()
    {
        importModal = false;
        csvImportDaten = "";
        importResults.Clear();
        StateHasChanged();
    }

    private async Task KundenImportieren()
    {
        if (string.IsNullOrWhiteSpace(csvImportDaten))
        {
            importResults.Add("❌ Bitte CSV-Daten eingeben");
            StateHasChanged();
            return;
        }

        isImporting = true;
        importResults.Clear();
        StateHasChanged();

        try
        {
            var results = await KundeService.ImportKundenFromCsvAsync(csvImportDaten);
            importResults = results;

            // Nach Import Daten aktualisieren
            await LoadKunden();
        }
        catch (Exception ex)
        {
            importResults.Add($"❌ Import fehlgeschlagen: {ex.Message}");
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }

    private async Task DownloadFile(string content, string fileName, string contentType)
    {
        var bytes = Encoding.UTF8.GetBytes(content);
        var base64 = Convert.ToBase64String(bytes);
        await JSRuntime.InvokeVoidAsync("downloadFile", base64, fileName, contentType);
    }

    private async Task ScrollToForm()
    {
        await JSRuntime.InvokeVoidAsync("eval", "document.querySelector('form').scrollIntoView({ behavior: 'smooth' })");
    }
}
        await LoadKunden();