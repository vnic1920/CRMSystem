@page "/kunden"
@using CRMSystem.Services
@using CRMSystem.Models
@using CRMSystem.Data
@using System.Text
@using System.ComponentModel.DataAnnotations
@inject IKundeService KundeService
@inject IJSRuntime JSRuntime

<h1>Kunden Übersicht</h1>

<!-- Erweiterte Suche und Filter -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <input @bind="suchText" @oninput="@((ChangeEventArgs e) => { suchText = e.Value?.ToString() ?? ""; FilternUndSortieren(); })" class="form-control" placeholder="Namen, Email oder Firma suchen..." />
            <button @onclick="SuchTextLeeren" class="btn btn-outline-secondary" type="button" title="Suche löschen">
                ✕
            </button>
        </div>
    </div>
    <div class="col-md-3">
        <select value="@sortierung" @onchange="@((ChangeEventArgs e) => { sortierung = e.Value?.ToString() ?? "name"; FilternUndSortieren(); })" class="form-select">
            <option value="name">Nach Name A-Z</option>
            <option value="namedesc">Nach Name Z-A</option>
            <option value="firma">Nach Firma</option>
            <option value="datum">Neueste zuerst</option>
            <option value="datumalt">Älteste zuerst</option>
        </select>
    </div>
    <div class="col-md-3">
        <select value="@statusFilter" @onchange="@((ChangeEventArgs e) => { statusFilter = e.Value?.ToString() ?? "alle"; FilternUndSortieren(); })" class="form-select">
            <option value="alle">Alle Kunden</option>
            <option value="mitFirma">Mit Firma</option>
            <option value="ohneFirma">Ohne Firma</option>
            <option value="mitTelefon">Mit Telefon</option>
            <option value="heute">Heute erstellt</option>
        </select>
    </div>
</div>

<!-- Filter-Status -->
@if (!string.IsNullOrEmpty(suchText) || statusFilter != "alle")
{
    <div class="alert alert-light mb-3">
        <small>
            @if (!string.IsNullOrEmpty(suchText))
            {
                <span>🔍 Suche: "<strong>@suchText</strong>"</span>
            }
            @if (statusFilter != "alle")
            {
                <span class="ms-2">📊 Filter: <strong>@statusFilter</strong></span>
            }
            <span class="ms-2">📈 Gefunden: <strong>@gefilterteKunden.Count</strong> von @kunden.Count Kunden</span>
            <button @onclick="AlleFilterZuruecksetzen" class="btn btn-sm btn-outline-secondary ms-2">Alle Filter löschen</button>
        </small>
    </div>
}

<h3>Neuen Kunden anlegen</h3>
<EditForm Model="neuerKunde" OnValidSubmit="KundeHinzufuegen">
    <DataAnnotationsValidator />
    <div class="row">
        <div class="col-md-6">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">Name *</label>
                        <InputText @bind-Value="neuerKunde.Name" class="form-control" placeholder="Vor- und Nachname" />
                        <ValidationMessage For="@(() => neuerKunde.Name)" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Email</label>
                        <InputText @bind-Value="neuerKunde.Email" class="form-control" placeholder="email@beispiel.de" />
                        <ValidationMessage For="@(() => neuerKunde.Email)" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Telefon</label>
                        <InputText @bind-Value="neuerKunde.Telefon" class="form-control" placeholder="+49 123 456789" />
                        <ValidationMessage For="@(() => neuerKunde.Telefon)" />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">Firma</label>
                        <InputText @bind-Value="neuerKunde.Firma" class="form-control" placeholder="Firmenname" />
                        <ValidationMessage For="@(() => neuerKunde.Firma)" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Adresse</label>
                        <InputTextArea @bind-Value="neuerKunde.Adresse" class="form-control" placeholder="Straße, PLZ, Stadt" rows="3" />
                        <ValidationMessage For="@(() => neuerKunde.Adresse)" />
                    </div>
                </div>
            </div>
            <div class="form-group mb-3">
                <label class="form-label">Notizen</label>
                <InputTextArea @bind-Value="neuerKunde.Notizen" class="form-control" placeholder="Interne Notizen..." rows="2" />
                <ValidationMessage For="@(() => neuerKunde.Notizen)" />
            </div>
            <button type="submit" class="btn btn-success mt-2">
                ➕ Kunde hinzufügen
            </button>
        </div>
    </div>
</EditForm>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert alert-info mt-3">@statusMessage</div>
}

<div class="d-flex justify-content-between align-items-center mt-4">
    <h3>Kundenliste</h3>
    <button @onclick="Exportieren" class="btn btn-success" title="Daten exportieren">
        📤 CSV Export
    </button>
</div>

@if (gefilterteKunden.Count == 0)
{
    <div class="alert alert-warning">
        <strong>Keine Kunden gefunden.</strong> @(kunden.Count == 0 ? "Fügen Sie Ihren ersten Kunden hinzu!" : "Versuchen Sie einen anderen Suchbegriff.")
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Kontakt</th>
                    <th>Firma</th>
                    <th>Erstellt am</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var kunde in gefilterteKunden)
                {
                    <tr>
                        <td><strong>#@kunde.Id</strong></td>
                        <td>
                            <div class="fw-bold">@kunde.Name</div>
                            @if (!string.IsNullOrEmpty(kunde.Notizen))
                            {
                                <small class="text-muted" title="@kunde.Notizen">📝</small>
                            }
                        </td>
                        <td>
                            <div>📧 @kunde.Email</div>
                            @if (!string.IsNullOrEmpty(kunde.Telefon))
                            {
                                <div>📞 @kunde.Telefon</div>
                            }
                        </td>
                        <td>@kunde.Firma</td>
                        <td>
                            <small class="text-muted">@kunde.Erstellungsdatum.ToString("dd.MM.yyyy")</small>
                        </td>
                        <td>
                            <button @onclick="() => BearbeitenStarten(kunde.Id)"
                                    class="btn btn-warning btn-sm" title="Kunde bearbeiten">
                                ✏️ Bearbeiten
                            </button>
                            <button @onclick="() => LoeschenBestätigen(kunde)"
                                    class="btn btn-danger btn-sm" title="Kunde löschen">
                                🗑️ Löschen
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!-- Bearbeiten Modal -->
@if (bearbeitenModal)
{
    <div class="modal show d-block" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kunde bearbeiten</h5>
                    <button type="button" class="btn-close" @onclick="BearbeitenAbbrechen"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Name *</label>
                                <input @bind="bearbeitenKunde.Name" class="form-control" />
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">Email</label>
                                <input @bind="bearbeitenKunde.Email" class="form-control" />
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">Telefon</label>
                                <input @bind="bearbeitenKunde.Telefon" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Firma</label>
                                <input @bind="bearbeitenKunde.Firma" class="form-control" />
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">Adresse</label>
                                <textarea @bind="bearbeitenKunde.Adresse" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Notizen</label>
                        <textarea @bind="bearbeitenKunde.Notizen" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @onclick="BearbeitenAbbrechen" class="btn btn-secondary">Abbrechen</button>
                    <button @onclick="KundeAktualisieren" class="btn btn-primary">Speichern</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Löschen Modal -->
@if (loeschenModal)
{
    <div class="modal show d-block" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kunde löschen</h5>
                    <button type="button" class="btn-close" @onclick="LoeschenAbbrechen"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <h6>⚠️ Achtung: Diese Aktion kann nicht rückgängig gemacht werden!</h6>
                        <p class="mb-0">Sind Sie sicher, dass Sie den Kunden <strong>@loeschenKunde?.Name</strong> löschen möchten?</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @onclick="LoeschenAbbrechen" class="btn btn-secondary">Abbrechen</button>
                    <button @onclick="KundeLoeschen" class="btn btn-danger">🗑️ Endgültig löschen</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Navigation -->
<div class="mt-4">
    <a href="/" class="btn btn-secondary">← Dashboard</a>
    <a href="/aufgaben" class="btn btn-outline-secondary ms-2">📋 Aufgaben</a>
    <a href="/kontakte" class="btn btn-outline-secondary ms-2">📞 Kontakte</a>
</div>

@code {
    private List<Kunde> kunden = [];
    private List<Kunde> gefilterteKunden = [];
    private Kunde neuerKunde = new();
    private string statusMessage = "";
    private string suchText = "";
    private string sortierung = "name";
    private string statusFilter = "alle";

    private bool bearbeitenModal = false;
    private Kunde bearbeitenKunde = new();

    private bool loeschenModal = false;
    private Kunde? loeschenKunde;

    protected override async Task OnInitializedAsync()
    {
        await LoadKunden();
    }

    private async Task LoadKunden()
    {
        kunden = await KundeService.GetKundenAsync();
        FilternUndSortieren();
    }

    private void FilternUndSortieren()
    {
        var result = kunden;

        // Text-Suche
        if (!string.IsNullOrWhiteSpace(suchText))
        {
            var search = suchText.ToLower();
            result = result.Where(k =>
                k.Name.ToLower().Contains(search) ||
                (k.Email != null && k.Email.ToLower().Contains(search)) ||
                (!string.IsNullOrEmpty(k.Firma) && k.Firma.ToLower().Contains(search)) ||
                (!string.IsNullOrEmpty(k.Telefon) && k.Telefon.Contains(search))
            ).ToList();
        }

        // Status-Filter
        if (statusFilter != "alle")
        {
            result = statusFilter switch
            {
                "mitFirma" => result.Where(k => !string.IsNullOrEmpty(k.Firma)).ToList(),
                "ohneFirma" => result.Where(k => string.IsNullOrEmpty(k.Firma)).ToList(),
                "mitTelefon" => result.Where(k => !string.IsNullOrEmpty(k.Telefon)).ToList(),
                "heute" => result.Where(k => k.Erstellungsdatum.Date == DateTime.Today).ToList(),
                _ => result
            };
        }

        // Sortierung
        result = sortierung switch
        {
            "name" => result.OrderBy(k => k.Name).ToList(),
            "namedesc" => result.OrderByDescending(k => k.Name).ToList(),
            "firma" => result.OrderBy(k => k.Firma).ToList(),
            "datum" => result.OrderByDescending(k => k.Erstellungsdatum).ToList(),
            "datumalt" => result.OrderBy(k => k.Erstellungsdatum).ToList(),
            _ => result.OrderBy(k => k.Name).ToList()
        };

        gefilterteKunden = result;
        StateHasChanged();
    }

    private void SuchTextLeeren()
    {
        suchText = "";
        FilternUndSortieren();
    }

    private void AlleFilterZuruecksetzen()
    {
        suchText = "";
        statusFilter = "alle";
        sortierung = "name";
        FilternUndSortieren();
    }

    private async Task KundeHinzufuegen()
    {
        neuerKunde.Erstellungsdatum = DateTime.Now;
        await KundeService.AddKundeAsync(neuerKunde);
        statusMessage = $"✅ Kunde '{neuerKunde.Name}' wurde gespeichert!";

        neuerKunde = new Kunde();
        await LoadKunden();
    }

    private async Task BearbeitenStarten(int id)
    {
        var kunde = await KundeService.GetKundeByIdAsync(id);
        if (kunde != null)
        {
            bearbeitenKunde = new Kunde
            {
                Id = kunde.Id,
                Name = kunde.Name,
                Email = kunde.Email,
                Telefon = kunde.Telefon,
                Firma = kunde.Firma,
                Adresse = kunde.Adresse,
                Notizen = kunde.Notizen
            };
            bearbeitenModal = true;
            StateHasChanged();
        }
    }

    private void BearbeitenAbbrechen()
    {
        bearbeitenModal = false;
        bearbeitenKunde = new Kunde();
        StateHasChanged();
    }

    private async Task KundeAktualisieren()
    {
        await KundeService.UpdateKundeAsync(bearbeitenKunde);
        statusMessage = $"✅ Kunde '{bearbeitenKunde.Name}' wurde aktualisiert!";
        bearbeitenModal = false;
        await LoadKunden();
    }

    private void LoeschenBestätigen(Kunde kunde)
    {
        loeschenKunde = kunde;
        loeschenModal = true;
        StateHasChanged();
    }

    private void LoeschenAbbrechen()
    {
        loeschenModal = false;
        loeschenKunde = null;
        StateHasChanged();
    }

    private async Task KundeLoeschen()
    {
        if (loeschenKunde != null)
        {
            await KundeService.DeleteKundeAsync(loeschenKunde.Id);
            statusMessage = $"🗑️ Kunde '{loeschenKunde.Name}' wurde gelöscht!";
            loeschenModal = false;
            loeschenKunde = null;
            await LoadKunden();
        }
    }

    private async Task Exportieren()
    {
        try
        {
            var csvData = await KundeService.ExportKundenToCsvAsync();
            var fileName = $"Kunden_Export_{DateTime.Now:yyyy-MM-dd_HH-mm}.csv";
            await DownloadFile(csvData, fileName, "text/csv");
            statusMessage = $"✅ Export erfolgreich! Datei '{fileName}' wurde heruntergeladen.";
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Export fehlgeschlagen: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task DownloadFile(string content, string fileName, string contentType)
    {
        var bytes = Encoding.UTF8.GetBytes(content);
        var base64 = Convert.ToBase64String(bytes);
        await JSRuntime.InvokeVoidAsync("downloadFile", base64, fileName, contentType);
    }
}